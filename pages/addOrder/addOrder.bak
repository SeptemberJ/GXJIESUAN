<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>新增订单</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<script src="../../js/common.js"></script>
		<script src="../../js/jquery-3.3.1.min.js"></script>
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link href="../../css/style.css" rel="stylesheet" />
		<style>
			html , body{
				background: #fff;
			}
			.mui-content{
				background: #fff !important;
			}
			.OrderItem{
				padding: 10px;
				border-top: 0px solid #efefef;
				border-bottom: 0px solid #efefef;
				font-size: 12px;
				font-weight: bold;
				text-align: left;
			}
			.OrderItem input{
				width: 100%;
				padding: 5px !important;
				font-size: 12px;
				border-radius: 0 !important;
				border: 0px !important;
				border-bottom: 1px solid #333 !important;
			}
			select{
				width: 100%;
				font-size: 12px;
				padding: 0;
				margin-top: 0;
				-webkit-appearance: menulist;
			    box-sizing: border-box;
			    align-items: center;
			    white-space: pre;
			    -webkit-rtl-ordering: logical;
			    color: black;
			    background-color: white;
			    cursor: default;
			    border-width: 1px;
			    border-style: solid;
			    border-color: initial;
			    border-image: initial;
			}
		</style>
	</head>

	<body>
		<div class="mui-content">
		    <div class="mui-row Margin_T0">
		        <div class="mui-col-xs-12 ">
		        	<span id="addOneOrder" class="mui-icon mui-icon-plus FloatRight"></span>
		        </div>
		    </div>
		</div>
		<div class="mui-content" id="content">
		    <div class="mui-row OrderItem">
		        <div class="mui-col-sm-2 mui-col-xs-2 ">
		            	<span>压贴</span>
		        </div>
		        <div class="mui-col-sm-10 mui-col-xs-10 ">
		            	<span id="OrderNo"></span>
		        </div>
		    </div>
		    <div class="mui-row OrderItem">
		        <div class="mui-col-sm-2 mui-col-xs-2 ">
		            	<span>开始时间</span>
		        </div>
		        <div class="mui-col-sm-10 mui-col-xs-10 ">
		        		<span id="OrderNote">结束时间</span>
		            	<!--<input placeholder="请输入描述" id="OrderNote" onkeyup="changeOrderNote()"/>-->
		        </div>
		    </div>
		</div>
		<div class="mui-content-padded">
			<button id='save' class="mui-btn mui-btn-block mui-btn-primary">保存</button>
		</div>
		
		<script src="../../js/mui.min.js"></script>
		<script type="text/javascript">
			mui.init();
			var mask = mui.createMask();
			var Url = 'http://220.248.107.62:8086/gxJK/'
			var OrderGongXuList = []
			var OrderGongXuHtml = ''
			var OrderData = {
				'order_no':window.localStorage.getItem('orderId'),
				'orderDetailArray':[]
			}
			var addOneOrder = document.getElementById('addOneOrder');
			var GetOrderGongXuList = function(){
				mui.get(Url + 'orderGongXuList',{},function(data){
						OrderGongXuList = data.orderGongXuList
						data.orderGongXuList.map(function(Item,Idx){
		            		OrderGongXuHtml += '<option  value='+ Item.gx_name+'>'+ Item.gx_name+ '</option>'
		            	})
					},'json'
				);
			}
			var ReLogin = function(){
				mui.openWindow({
				    url:'../../index.html',
				    id:'index.html',
				})
			}
			//获取订单详情
			var GetOrderDetail =  function(){
				if(window.localStorage.getItem('orderId')){
					mui.get(Url + 'orderDetail',{'order_no':window.localStorage.getItem('orderId')},function(data){
							$('#OrderNo')[0].innerHTML = window.localStorage.getItem('orderId')
							$('#OrderNote')[0].innerHTML = '描述'//data.orderDetail
							var NewHtml = ''
							data.orderDetail.map(function(Item,Idx){
								NewHtml = NewHtml + '<div class="mui-row OrderItem">'+
												        '<div class="mui-col-sm-2 mui-col-xs-2 ">'+
												            	'<span>工序</span>'+
												        '</div>'+
												        '<div class="mui-col-sm-5 mui-col-xs-5 ">'+
											            	'<span>' + Item.gongxu +'</span>'+
												        '</div>'+
												        '<div class="mui-col-sm-5 mui-col-xs-5 ">'+
												            	'<span>' + Item.fnumber +'</span>'+
												        '</div>'+
												    '</div>'
			            	})
							$('#content').append(NewHtml)
						},'json'
					);
				}else{
					mui.alert( '请重新登录!', '提示', function(e){
						ReLogin()
					})
				}
			}
			GetOrderDetail()
			//日期格式化
			var formatTime = function(date) {
				var year = date.getFullYear()
				var month = date.getMonth() + 1
				var day = date.getDate()
				var hour = date.getHours()
				var minute = date.getMinutes()
				var second = date.getSeconds()
				return [year, month, day].map(formatNumber).join('') + [hour, minute, second].map(formatNumber).join('')
			}
			var formatNumber = function(n) {
				n = n.toString()
				return n[1] ? n : '0' + n
			}
			//描述
			var changeOrderNote = function(e){
				OrderData.order_note = $('#OrderNote')[0].value
			}
			GetOrderGongXuList()
			//对应工序code
			var changeOrderGongxu = function(Idx){
				OrderData.orderDetailArray[Idx - 1].gongxu = $('.gongxuList')[Idx - 1].value
			}
			//对应工序数量
			var changeGongxuAmount = function(Idx){
				OrderData.orderDetailArray[Idx - 1].fnumber = $('.gongxuAmount')[Idx - 1].value
			}
			
			//新增一行
			addOneOrder.addEventListener('tap', function(event) {
				var OrderItemObj = {
					'gongxu': OrderGongXuList[0].gx_code,
					'fnumber': 0,
					'userid': window.localStorage.getItem('userid')
				}
				OrderData.orderDetailArray.push(OrderItemObj)
				var NewHtml = ''
				NewHtml = NewHtml + '<div class="mui-row OrderItem">'+
								        '<div class="mui-col-sm-2 mui-col-xs-2 ">'+
								            	'<span>工序</span>'+
								        '</div>'+
								        '<div class="mui-col-sm-5 mui-col-xs-5 ">'+
							            	'<select name="gongxuList" class="gongxuList" onchange="changeOrderGongxu('+ (OrderData.orderDetailArray.length)+')">'+
							            		OrderGongXuHtml+
							            	'</select>'+
								        '</div>'+
								        '<div class="mui-col-sm-5 mui-col-xs-5 ">'+
								            	'<input placeholder="请输入数量" class="gongxuAmount" onkeyup="changeGongxuAmount('+ (OrderData.orderDetailArray.length)+')"/>'+
								        '</div>'+
								    '</div>'
				$('#content').append(NewHtml)
			})
			//保存
			save.addEventListener('tap',function(){
				var ReLogin = function(){
					mui.openWindow({
					    url:'../../index.html',
					    id:'index.html',
					})
				}
				var ConfirmSave = function(){
		    		if(window.localStorage.getItem('userid')){
		    			mask.show()
			    		mui.ajax(Url + 'insertOrderDeatail',{
							data:OrderData,
							dataType:'json',
							type:'post',
							timeout:10000,
							headers:{'Content-Type':'application/json'},	              
							success:function(data){
								switch(data.code){
									case 0:
										mui.toast(data.message,{ duration:'1500', type:'div' })
										mui.back()
										break
									default:
										mask.close()
										mui.toast(data.message,{ duration:'1500', type:'div' })
								}
								
							},
							error:function(xhr,type,errorThrown){
								//异常处理；
								console.log(type);
							}
						});
			    	}else{
			    		mui.alert( '请重新登录!', '提示', function(e){
							ReLogin()
						})
			    	}
		    	}
				//为空校验
				var ifEmpty = false
				OrderData.orderDetailArray.map(function(Item,Idx){
					if(Item.fnumber == 0 || Item.fnumber == ''){
						ifEmpty = true
					}
				})
				if(ifEmpty){
					mui.alert( '数量不能为空!', '提示')
					return false
				}else{
					ConfirmSave()
				}
				
			})
		</script>
	</body>

</html>